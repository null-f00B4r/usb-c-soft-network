name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_hardware_tests:
        description: 'Run hardware integration tests (requires privileged runner)'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build devcontainer image
      run: |
        docker build -f .devcontainer/Dockerfile -t usb-c-soft-network-ci:latest .

    - name: Run build inside devcontainer image
      run: |
        docker run --rm -e "TEST_HARDWARE=OFF" -v "${{ github.workspace }}:/workspaces/usb-c-soft-network" usb-c-soft-network-ci:latest bash -lc "cd /workspaces/usb-c-soft-network && ./scripts/build.sh"

  hardware-tests:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event.inputs.run_hardware_tests == 'true' || contains(github.event.pull_request.labels.*.name, 'hardware-tests') }}
    steps:
    - uses: actions/checkout@v4
    - name: Build devcontainer image (for hardware tests)
      run: |
        docker build -f .devcontainer/Dockerfile -t usb-c-soft-network-ci:latest .

    - name: Run hardware tests (PR label or workflow dispatch required)
      run: |
        echo "Running hardware tests disabled by default. Ensure you run this only in a secure environment"
        docker run --rm --privileged -e "TEST_HARDWARE=ON" -v "${{ github.workspace }}:/workspaces/usb-c-soft-network" usb-c-soft-network-ci:latest bash -lc "cd /workspaces/usb-c-soft-network && ./scripts/build.sh && echo 'Hardware tests would run here (skipped)'; exit 0"
